#!/usr/bin/env bash
# chezmoi:template:left-delimiter="# [[" right-delimiter=]]

# Exit on error. Append || true if you expect an error.
set -o errexit
# Exit on error inside any functions or subshells.
set -o errtrace
# Do not allow use of undefined vars. Use ${VAR:-} to use an undefined VAR
set -o nounset
# Catch the error in case mysqldump fails (but gzip succeeds) in `mysqldump |gzip`
set -o pipefail
# Turn on traces, useful while debugging but commented out by default
#set -o xtrace

export PATH=# [[ includeTemplate "path" | trim | quote ]]

# [[- $brews := list
      "go"
      "fzf"
      "dive"
      "jq"
      "git"
      "htop"
      "tree"
      "curl"
      "direnv"
      "pandoc"
      "ipcalc"
      "powerline-go"
      "terraform"
      "terragrunt"
      "packer"
      "kubernetes-cli"
      "kubectx"
      "stern"
      "k9s"
      "vault"
      "chezmoi"
      "helm"
      "pv"
      "rustup-init"
      "jrockway/tap/jlog"
      "tealdeer"
]]
# TODO need to verify that neo4j no longer needs admin access on a mac
# [[ $casks := list -]]
# [[ $taps := list "jrockway/tap" -]]
# [[ $mases := dict -]]

# [[- if .full -]]
# [[-   $brews = concat $brews (list
        "ansible"
        "awscli"
        "azure-cli"
        "openjdk@17"
        "maven"
        "pgcli"
        "neo4j"
      )
-]]
# [[- end -]]


# [[- if eq .chezmoi.os "darwin" -]]
# [[-   $casks = concat $casks (list
        "hammerspoon"
        "stats"
        "firefox"
        "google-chrome"
        "visual-studio-code"
        "jetbrains-toolbox"
        "iterm2"
        "keeweb"
        "font-liberation-mono-for-powerline"
        "slack"
      )
-]]
# [[/*
# Temporarily needed until https://github.com/Homebrew/homebrew-core/pull/97394
# Re-add `"dockutil"` to brews list when merged
*/]]
# [[-   $casks = concat $casks (list
       "hpedrorodrigues/tools/dockutil"
      )
-]]

# [[/*
# readline - .inputrc
# blueutil - used by Hammerspoon scripts
# dockutil - manipulate the dock
# svn - Needed by font-liberation-mono-for-powerline, for some reason
*/]]
# [[-   $brews = concat $brews (list
      "bash-completion"
      "readline"
      "watch"
      "blueutil"
      "svn"
      )
-]]

# [[/*
# For font-liberation-mono-for-powerline
*/]]
# [[-   $taps = concat $taps (list
      "homebrew/cask-fonts"
      )
-]]

# [[-   if .full -]]
# [[-     $casks = concat $casks (list
          "google-cloud-sdk"
          "drawio"
          "libreoffice"
          "gimp"
          "inkscape"
        )
-]]
# [[-     if .admin -]]
# [[-       $casks = concat $casks (list
            "docker"
          )
-]]
# [[/*
# mas needs admin permissions depending on what it installs
*/]]
# [[-       $brews = concat $brews (list
            "mas"
          )
-]]
# [[-     end -]]
# [[-   end -]]
# [[- end -]]

brew bundle --no-lock --file=/dev/stdin <<EOF
# [[ range ($taps | sortAlpha | uniq) -]]
tap "# [[ . ]]"
# [[ end -]]

# [[ range ($brews | sortAlpha | uniq) -]]
brew "# [[ . ]]"
# [[ end -]]

cask_args appdir: '~/Applications'
# [[ range ($casks | sortAlpha | uniq) -]]
cask "# [[ . ]]"
# [[ end -]]

# [[ range $k, $v := $mases -]]
mas "# [[ $v ]]", id: # [[ $k ]]
# [[ end -]]
EOF
